# 11. Fault Handling and Analysis

**What is a Fault?**  
A fault is an exception generated by the processor to indicate an error.

**Why Do Faults Happen?**  
- Faults can occur when programmers violate the design rules of the processor or when there are issues with the interfaces the processor interacts with.
- When a fault occurs, the internal processor registers are updated to record the type of fault, the address of the instruction where it happened, and if the related exception is enabled, the processor will call the exception handler.
- In the exception handler, programmers can implement code to report, resolve, or recover from the fault. 
- For example, if your code attempts to divide a number by zero, a divide-by-zero fault will be raised by the hardware, triggering the usage fault exception handler (if enabled). In this handler, you can decide how to handle the issue, such as terminating the task.
- Most faults occur when the programmer's code does not follow the processor's programming guidelines.

**Types of Fault Exceptions in Cortex-Mx Processors:**
- **Hard Fault Exception:** Enabled by default, with a non-configurable priority.
- **Usage Fault Exception:** Disabled by default, but the priority can be configured.
- **Memory Management Fault Exception:** Disabled by default, but the priority can be configured.
- **Bus Fault Exception:** Disabled by default, but the priority can be configured.

*Note: The hard fault exception can be disabled by using the FAULTMASK register.*

## Hard-Fault Exception

A HardFault is an exception that occurs due to an error during exception processing or when no other exception mechanism can handle a specific issue. It has the third highest fixed priority (-1) after the reset and Non-Maskable Interrupt (NMI), meaning it takes precedence over any exception with a configurable priority.

**Causes of Hard-Faults:**
1. Escalation of configurable fault exceptions.
2. Bus error that occurs during a vector fetch.
3. Execution of a breakpoint instruction when both halt mode and debug monitoring are disabled.
4. Executing the SVC instruction inside the SVC handler.

## Other Configurable Faults

Hereâ€™s a clearer and more straightforward version of your text:

### Memory Management Fault Exception

- This is a configurable fault exception that is disabled by default. 
- You can enable it by configuring the **System Handler Control and State Register (SHCSR)**.
- When a memory management fault occurs, the processor executes the memory management fault exception handler.
- The priority of this fault exception can be configured.

Causes of Memory Management Faults:
1. This fault triggers when there is a violation of memory access permissions set by the processor or Memory Protection Unit (MPU).
2. Unprivileged thread mode code (such as user applications or RTOS tasks) attempts to access a memory region marked as "privileged access only" by the MPU.
3. Writing to memory regions designated as read-only by the MPU.
4. Trying to execute program code from peripheral memory regions, which are marked as execute-never (XN) by the processor to prevent code injection attacks through peripherals.

### Bus Fault Exception

- This is a configurable fault exception that is disabled by default.
- You can enable it by configuring the **System Handler Control and State Register (SHCSR)**.
- When a bus fault occurs, the processor executes the bus fault exception handler.
- The priority of this fault exception can be configured.

Causes of Bus Faults:
- An error response from the processor bus interfaces during memory device access, which can happen during:
  - Instruction fetch
  - Data read or write operations
- If a bus error occurs during a vector fetch, it escalates to a hard fault, even if the bus fault exception is enabled.
- A memory device may send an error response when trying to access invalid or restricted memory locations, leading to a bus fault.
- Issues may occur when the device is not ready to accept memory transfers, particularly with external memories like SDRAM connected through DRAM controllers.
- Unprivileged access to the private peripheral bus can also trigger a bus fault.

### Usage Fault Exception

- This is a configurable fault exception that is disabled by default.
- You can enable it by configuring the **System Handler Control and State Register (SHCSR)**.
- When a usage fault occurs, the processor executes the usage fault exception handler.
- The priority of this fault exception can be configured.

Causes of Usage Faults:
1. Execution of an undefined instruction (Cortex-M4 only supports the Thumb instruction set; executing ARM instructions will trigger a fault).
2. Executing floating-point instructions while the floating-point unit is disabled.
3. Attempting to switch to ARM state to execute ARM instructions; the T bit in the processor determines the state. For Cortex-M, this bit should be set to 1. Setting it to 0 (which may occur during function calls using function pointers) will result in a fault.
4. Trying to return to thread mode while an exception or interrupt is still active.
5. Unaligned memory access with multiple load or store instructions.
6. Attempting to divide by zero (by default, dividing by zero results in zero, unless enabled).
7. Unaligned data access from memory (only if enabled; otherwise, Cortex-M supports unaligned data access).

## Stack Frame

As explained in Exception handling sequences, Cortex-M processors use stacking to automatically push a number of registers to stack memory on exception entry, then use unstacking to restore those registers from stack memory when returning to the pre-empted context.

---

Next: [12. System Level Services](12_system_level.md)